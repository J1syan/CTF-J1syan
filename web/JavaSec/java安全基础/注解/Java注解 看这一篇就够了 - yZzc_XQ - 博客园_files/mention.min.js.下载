(function(n){n.fn.extend({mention:function(t){this.opts={users:[],delimiter:"@",sensitive:!0,queryBy:"DisplayName",typeaheadOpts:{}};var i=n.extend({},this.opts,t),r=function(){if(typeof n=="undefined")throw new Error("jQuery is Required");else if(typeof n.fn.typeahead=="undefined")throw new Error("Typeahead is Required");return!0},u=function(n,t){for(var r=t;r>=0;r--)if(n[r]==i.delimiter)break;return n.substring(r,t)},f=function(){var n;if(this.query=this.query.toLowerCase(),this.query.indexOf(i.delimiter)>-1){var u=this.query.lastIndexOf(i.delimiter),t=document.querySelector("#"+this.$element[0].id),r=getCaretCoordinates(t,this.query.lastIndexOf(i.delimiter)+1),f=getComputedStyle(t).getPropertyValue("font-size").replace("px","");if(this.at_top=r.top+parseInt(f),this.at_left=r.left,n=this.query.substring(u+1),n.indexOf(" ")==-1&&n.length>0)this.query=n;else{if(n!="")return!1;this.query=""}return!0}return!1},e=function(n){for(var t=this.textValue,u=this.$element[0].selectionStart,r=u;r>=0;r--)if(t[r]==i.delimiter)break;var o=t.substring(r,u),f=t.substring(0,r),e=t.substring(u),t=f+i.delimiter+n+e;return this.tempQuery=t,t},o=function(n){var t,s;if(n.length&&i.sensitive){var e=u(this.query,this.$element[0].selectionStart).substring(1),r,h=n.length,f={highest:[],high:[],med:[],low:[]},o=[];if(e.length==1){for(r=0;r<h;r++)t=n[r],t.DisplayName[0]==e?f.highest.push(t):t.DisplayName[0].toLowerCase()==e.toLowerCase()?f.high.push(t):t.DisplayName.indexOf(e)!=-1?f.med.push(t):f.low.push(t);for(r in f)for(s in f[r])o.push(f[r][s]);return o}}return n},s=function(t){var i=this;return t=n(t).map(function(t,r){t=n(i.options.item);var u=n("<div />");return r.IconUrl&&u.append('<img class="mention_image" src="'+r.IconUrl+'">'),r.DisplayName&&u.append('<b class="mention_name">'+r.DisplayName+"<\/b>"),t.find("a").html(i.highlighter(u.html())),t[0]}),t.first().addClass("active"),this.$menu.html(t),this};return n.fn.typeahead.Constructor.prototype.render=s,this.each(function(){var t=n(this);r()&&t.typeahead(n.extend({source:i.users,matcher:f,updater:e,sorter:o},i.typeaheadOpts))})}})})(jQuery);!function(n){"use strict";var t=function(t,i){this.$element=n(t);this.options=n.extend({},n.fn.typeahead.defaults,i);this.matcher=this.options.matcher||this.matcher;this.sorter=this.options.sorter||this.sorter;this.highlighter=this.options.highlighter||this.highlighter;this.updater=this.options.updater||this.updater;this.source=this.options.source;this.search=this.options.search;this.under=this.options.under||!1;this.fixed=this.options.fixed||!1;this.sort=this.options.sort||!1;this.input_text=this.options.input_text||!1;this.url=this.options.url||location.protocol+"//mention.cnblogs.com/mention-users";this.item_count=this.options.item_count||10;this.textValue;this.at_top;this.at_left;this.$menu=n(this.options.menu);this.shown=!1;this.listen();this.lookupTimeout},i;t.prototype={constructor:t,select:function(){var n=" ",t;return this.query==""&&(n=""),t=this.$menu.find(".active").text(),this.$element.val(this.updater(t+n)).change(),this.hide()},updater:function(n){return n},show:function(){var t=n.extend({},this.$element.position(),{top:this.$element[0].offsetTop,height:this.$element[0].offsetHeight}),i,r;return this.shown&&this.fixed?this.$menu.show():(this.under?(i=t.top+this.at_top,r=t.left+this.at_left):this.input_text?(i=t.top+t.height,r=t.left+this.at_left):(i=t.top+t.height,r=t.left),this.$menu.insertAfter(this.$element).css({top:i,left:r}).show()),this.shown=!0,this},hide:function(){return this.$menu.hide(),this.shown=!1,this},lookup:function(){var t=this,i;if(this.query=this.$element.val(),this.textValue=this.query,!this.query||this.query.length<this.options.minLength)return this.shown?this.hide():this;if(this.matcher())if(clearTimeout(this.lookupTimeout),this.search)if(this.query=="")this.$menu.html('<b class="tips">输入要@的人<\/b>'),this.show();else return this.source=this.search(this.query),i=this.source,i?this.process(i):this;else this.query==""?(this.$menu.html('<b class="tips">输入要@的人<\/b>'),this.show()):this.lookupTimeout=setTimeout(function(){t.lookupTimeout=null;n.ajax({timeout:1e3,type:"get",dataType:"json",contentType:"application/json; charset=utf-8",url:t.url+"?displayName="+encodeURIComponent(t.query)+"&itemCount="+t.item_count,success:function(n){return t.source=n,i=t.source,i?t.process(i):t},error:function(n){console.log(n)}})},300);else this.shown&&this.hide()},process:function(n){var t=this;return(this.sort&&(n=this.sorter(n)),!n.length)?this.shown?this.hide():this:this.render(n.slice(0,this.options.items)).show()},matcher:function(n){return~n.toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(n){for(var i=[],r=[],u=[],t;t=n.shift();)t.toLowerCase().indexOf(this.query.toLowerCase())?~t.indexOf(this.query)?r.push(t):u.push(t):i.push(t);return i.concat(r,u)},highlighter:function(n){var t=this.textValue.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&");return n.replace(new RegExp("("+t+")","ig"),function(n,t){return"<strong>"+t+"<\/strong>"})},render:function(t){var i=this;return t=n(t).map(function(t,r){return t=n(i.options.item).text(r),t.find("a").html(i.highlighter(r)),t[0]}),t.first().addClass("active"),this.$menu.html(t),this},next:function(){var i=this.$menu.find(".active").removeClass("active"),t=i.next();t.length||(t=n(this.$menu.find("li")[0]));t.addClass("active")},prev:function(){var t=this.$menu.find(".active").removeClass("active"),n=t.prev();n.length||(n=this.$menu.find("li").last());n.addClass("active")},listen:function(){this.$element.on("focus",n.proxy(this.focus,this)).on("blur",n.proxy(this.blur,this)).on("keypress",n.proxy(this.keypress,this)).on("keyup",n.proxy(this.keyup,this));if(this.eventSupported("keydown"))this.$element.on("keydown",n.proxy(this.keydown,this));this.$menu.on("click","li",n.proxy(this.click,this)).on("mouseenter","li",n.proxy(this.mouseenter,this)).on("mouseleave","li",n.proxy(this.mouseleave,this))},eventSupported:function(n){var t=n in this.$element;return t||(this.$element.setAttribute(n,"return;"),t=typeof this.$element[n]=="function"),t},move:function(n){if(this.shown){switch(n.keyCode){case 9:case 13:case 27:n.preventDefault();break;case 38:n.preventDefault();this.prev();break;case 40:n.preventDefault();this.next()}n.stopPropagation()}},keydown:function(t){this.suppressKeyPressRepeat=~n.inArray(t.keyCode,[40,38,9,13,27]);this.move(t)},keypress:function(n){this.suppressKeyPressRepeat||this.move(n)},keyup:function(n){switch(n.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:case 13:if(!this.shown)return;this.select();break;case 27:if(!this.shown)return;this.hide();break;default:this.lookup()}n.stopPropagation();n.preventDefault()},focus:function(){this.focused=!0},blur:function(){this.focused=!1;!this.mousedover&&this.shown&&this.hide()},click:function(n){n.stopPropagation();n.preventDefault();this.select();this.$element.focus()},mouseenter:function(t){this.mousedover=!0;this.$menu.find(".active").removeClass("active");n(t.currentTarget).addClass("active")},mouseleave:function(){this.mousedover=!1;!this.focused&&this.shown&&this.hide()}};i=n.fn.typeahead;n.fn.typeahead=function(i){return this.each(function(){var u=n(this),r=u.data("typeahead"),f=typeof i=="object"&&i;r||u.data("typeahead",r=new t(this,f));typeof i=="string"&&r[i]()})};n.fn.typeahead.defaults={source:[],items:8,menu:'<ul class="typeahead dropdown-menu"><\/ul>',item:'<li><a href="#"><\/a><\/li>',minLength:1};n.fn.typeahead.Constructor=t;n.fn.typeahead.noConflict=function(){return n.fn.typeahead=i,this};n(document).on("focus.typeahead.data-api",'[data-provide="typeahead"]',function(){var t=n(this);t.data("typeahead")||t.typeahead(t.data())})}(window.jQuery),function(){function t(t,u,f){var c,l,s,h,v;if(!n)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");c=f&&f.debug||!1;c&&(l=document.querySelector("#input-textarea-caret-position-mirror-div"),l&&l.parentNode.removeChild(l));s=document.createElement("div");s.id="input-textarea-caret-position-mirror-div";document.body.appendChild(s);var o=s.style,e=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,a=t.nodeName==="INPUT";return o.whiteSpace="pre-wrap",a||(o.wordWrap="break-word"),o.position="absolute",c||(o.visibility="hidden"),i.forEach(function(n){if(a&&n==="lineHeight")if(e.boxSizing==="border-box"){var t=parseInt(e.height),i=parseInt(e.paddingTop)+parseInt(e.paddingBottom)+parseInt(e.borderTopWidth)+parseInt(e.borderBottomWidth),r=i+parseInt(e.lineHeight);o.lineHeight=t>r?t-i+"px":t===r?e.lineHeight:0}else o.lineHeight=e.height;else o[n]=e[n]}),r?t.scrollHeight>parseInt(e.height)&&(o.overflowY="scroll"):o.overflow="hidden",s.textContent=t.value.substring(0,u),a&&(s.textContent=s.textContent.replace(/\s/g," ")),h=document.createElement("span"),h.textContent=t.value.substring(u)||".",s.appendChild(h),v={top:h.offsetTop+parseInt(e.borderTopWidth),left:h.offsetLeft+parseInt(e.borderLeftWidth),height:parseInt(e.lineHeight)},c?h.style.backgroundColor="#aaa":document.body.removeChild(s),v}var i=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],n=typeof window!="undefined",r=n&&window.mozInnerScreenX!=null;typeof module!="undefined"&&typeof module.exports!="undefined"?module.exports=t:n&&(window.getCaretCoordinates=t)}();